<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Scraps n' Bids ‚Äî Live Auction</title>

        <!-- Vercel Analytics -->
        <script>
            window.va =
                window.va ||
                function () {
                    (window.vaq = window.vaq || []).push(arguments);
                };
        </script>
        <script defer src="https://va.vercel-scripts.com/v1/script.js"></script>
        <script>
            window.si =
                window.si ||
                function () {
                    (window.siq = window.siq || []).push(arguments);
                };
        </script>
        <script
            defer
            src="https://va.vercel-scripts.com/v1/speed-insights/script.js"
        ></script>

        <!-- ============================================================
       MODULE 2: CSS STYLES
       Warm color scheme, animations, responsive layout
       ============================================================ -->
        <style>
            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Helvetica, Arial, sans-serif;
                background-color: #faf6f1;
                color: #2d2d2d;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            header {
                text-align: center;
                padding: 2rem 1rem 1rem;
                width: 100%;
                max-width: 640px;
            }

            header h1 {
                font-size: 2rem;
                color: #b5451b;
                letter-spacing: -0.5px;
            }

            header .tagline {
                font-size: 0.95rem;
                color: #7a7a7a;
                margin-top: 0.25rem;
            }

            main {
                width: 100%;
                max-width: 640px;
                padding: 0 1rem 2rem;
                display: flex;
                flex-direction: column;
                gap: 1.25rem;
            }

            /* Auction Card */
            .auction-card {
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
                padding: 1.5rem;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.75rem;
            }

            .meal-photo {
                width: 200px;
                height: 200px;
                border-radius: 12px;
                object-fit: cover;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            }

            #meal-name {
                font-size: 1.4rem;
                font-weight: 700;
                color: #333;
            }

            #meal-description {
                font-size: 0.9rem;
                color: #666;
                text-align: center;
                max-width: 400px;
            }

            .category-badge {
                display: inline-block;
                background: #f0e6d6;
                color: #8b6914;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                padding: 0.2rem 0.6rem;
                border-radius: 999px;
            }

            /* Status Indicator */
            #auction-status {
                display: inline-flex;
                align-items: center;
                gap: 0.4rem;
                font-size: 0.85rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            #auction-status.live {
                color: #1a8a3f;
            }

            #auction-status.live::before {
                content: "";
                display: inline-block;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #1a8a3f;
                animation: pulse 1.2s ease-in-out infinite;
            }

            #auction-status.sold {
                color: #b5451b;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.4;
                    transform: scale(0.85);
                }
            }

            /* Countdown */
            #countdown {
                font-size: 3rem;
                font-weight: 800;
                font-variant-numeric: tabular-nums;
                color: #333;
                letter-spacing: 2px;
                transition: color 0.3s;
            }

            #countdown.warning {
                color: #cc2222;
            }

            /* Current Bid */
            .bid-display {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.15rem;
            }

            .bid-label {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: #999;
            }

            #current-bid {
                font-size: 2rem;
                font-weight: 800;
                color: #1a8a3f;
            }

            /* Bid Feed */
            .bid-feed {
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
                padding: 1rem 1.25rem;
                max-height: 260px;
                overflow-y: auto;
            }

            .bid-feed h2 {
                font-size: 0.8rem;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: #999;
                margin-bottom: 0.75rem;
            }

            #bid-list {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .bid-entry {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.4rem 0;
                border-bottom: 1px solid #f0ede8;
                animation: slideIn 0.3s ease-out;
            }

            .bid-entry:last-child {
                border-bottom: none;
            }

            .bid-name {
                font-weight: 600;
                color: #444;
                font-size: 0.9rem;
            }

            .bid-amount {
                font-weight: 700;
                color: #1a8a3f;
                font-size: 0.9rem;
            }

            .bid-time {
                font-size: 0.75rem;
                color: #aaa;
                margin-left: 0.5rem;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-8px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Winner Banner */
            #winner-banner {
                display: none;
                background: linear-gradient(135deg, #b5451b, #d4762c);
                color: #fff;
                border-radius: 12px;
                padding: 1.5rem;
                text-align: center;
                animation: bannerIn 0.5s ease-out;
            }

            #winner-banner.visible {
                display: block;
            }

            #winner-banner .winner-emoji {
                font-size: 2.5rem;
                margin-bottom: 0.5rem;
            }

            #winner-banner .winner-text {
                font-size: 1.1rem;
                font-weight: 700;
            }

            #winner-banner .winner-details {
                font-size: 0.9rem;
                opacity: 0.9;
                margin-top: 0.25rem;
            }

            @keyframes bannerIn {
                from {
                    opacity: 0;
                    transform: scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            /* End Screen */
            #end-screen {
                display: none;
                text-align: center;
                padding: 3rem 1rem;
            }

            #end-screen.visible {
                display: block;
            }

            #end-screen .end-emoji {
                font-size: 3rem;
                margin-bottom: 1rem;
            }

            #end-screen h2 {
                font-size: 1.6rem;
                color: #b5451b;
                margin-bottom: 0.5rem;
            }

            #end-screen p {
                color: #777;
                font-size: 0.95rem;
            }

            /* Hide auction UI when complete */
            .auction-card.hidden,
            .bid-feed.hidden {
                display: none;
            }

            /* Scrollbar styling */
            .bid-feed::-webkit-scrollbar {
                width: 6px;
            }

            .bid-feed::-webkit-scrollbar-thumb {
                background: #ddd;
                border-radius: 3px;
            }
        </style>
    </head>
    <body>
        <!-- ============================================================
       MODULE 1: HTML STRUCTURE
       Semantic layout with stable IDs for rtrvr agent parsing
       ============================================================ -->
        <header>
            <h1>Scraps n' Bids</h1>
            <p class="tagline">Live auctions for unfinished meals</p>
        </header>

        <main>
            <div class="auction-card" id="auction-card">
                <img
                    class="meal-photo"
                    id="meal-photo"
                    src=""
                    alt="Meal photo"
                />
                <h2 id="meal-name"></h2>
                <p id="meal-description"></p>
                <span class="category-badge" id="meal-category"></span>
                <span id="auction-status" class="live">LIVE</span>
                <div id="countdown">0:00</div>
                <div class="bid-display">
                    <span class="bid-label">Current Bid</span>
                    <span id="current-bid">$0.00</span>
                </div>
            </div>

            <div class="bid-feed" id="bid-feed">
                <h2>Bid History</h2>
                <div id="bid-list"></div>
            </div>

            <div id="winner-banner">
                <div class="winner-emoji"></div>
                <div class="winner-text"></div>
                <div class="winner-details"></div>
            </div>

            <div id="end-screen">
                <div class="end-emoji"></div>
                <h2></h2>
                <p></p>
            </div>
        </main>

        <!-- ============================================================
       JAVASCRIPT: POLLING CLIENT
       Fetches shared auction state from /api/state
       ============================================================ -->
        <script>
            (function() {
                // DOM element cache
                const els = {};
                let lastState = null;

                function cacheElements() {
                    els.mealPhoto = document.getElementById('meal-photo');
                    els.mealName = document.getElementById('meal-name');
                    els.mealDescription = document.getElementById('meal-description');
                    els.mealCategory = document.getElementById('meal-category');
                    els.auctionStatus = document.getElementById('auction-status');
                    els.countdown = document.getElementById('countdown');
                    els.currentBid = document.getElementById('current-bid');
                    els.bidList = document.getElementById('bid-list');
                    els.winnerBanner = document.getElementById('winner-banner');
                    els.auctionCard = document.getElementById('auction-card');
                    els.bidFeed = document.getElementById('bid-feed');
                }

                function formatCurrency(amount) {
                    return '$' + amount.toFixed(2);
                }

                function formatCountdown(seconds) {
                    const m = Math.floor(seconds / 60);
                    const s = seconds % 60;
                    return m + ':' + (s < 10 ? '0' : '') + s;
                }

                function formatRelativeTime(timestamp) {
                    const seconds = Math.floor((Date.now() - timestamp) / 1000);
                    if (seconds < 2) return 'just now';
                    if (seconds < 60) return seconds + 's ago';
                    const minutes = Math.floor(seconds / 60);
                    return minutes + 'm ago';
                }

                function renderState(state) {
                    const meal = state.meal;

                    // Update meal info
                    els.mealPhoto.src = meal.photo;
                    els.mealPhoto.alt = meal.name;
                    els.mealName.textContent = meal.name;
                    els.mealDescription.textContent = meal.description;
                    els.mealCategory.textContent = meal.category;

                    // Update countdown
                    els.countdown.textContent = formatCountdown(state.remaining);
                    if (state.remaining <= 10) {
                        els.countdown.classList.add('warning');
                    } else {
                        els.countdown.classList.remove('warning');
                    }

                    // Update current bid
                    const highestBid = state.bids.length > 0
                        ? state.bids[state.bids.length - 1].amount
                        : meal.startingBid;
                    els.currentBid.textContent = formatCurrency(highestBid);

                    // Update status
                    els.auctionStatus.className = '';
                    if (state.status === 'active') {
                        els.auctionStatus.textContent = 'LIVE';
                        els.auctionStatus.classList.add('live');
                        els.winnerBanner.classList.remove('visible');
                        els.auctionCard.classList.remove('hidden');
                        els.bidFeed.classList.remove('hidden');
                    } else if (state.status === 'sold') {
                        els.auctionStatus.textContent = 'SOLD';
                        els.auctionStatus.classList.add('sold');

                        // Show winner banner
                        if (state.winner) {
                            els.winnerBanner.querySelector('.winner-emoji').textContent = 'üéâüèÜüéâ';
                            els.winnerBanner.querySelector('.winner-text').textContent = state.winner.bidder + ' wins!';
                            els.winnerBanner.querySelector('.winner-details').textContent =
                                meal.name + ' sold for ' + formatCurrency(state.winner.amount);
                            els.winnerBanner.classList.add('visible');
                        }
                    }

                    // Update bid feed
                    renderBidFeed(state.bids);
                }

                function renderBidFeed(bids) {
                    const fragment = document.createDocumentFragment();
                    const reversed = bids.slice().reverse();

                    for (let i = 0; i < reversed.length; i++) {
                        const bid = reversed[i];
                        const entry = document.createElement('div');
                        entry.className = 'bid-entry';

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'bid-name';
                        nameSpan.textContent = bid.bidder;

                        const rightSide = document.createElement('span');

                        const amountSpan = document.createElement('span');
                        amountSpan.className = 'bid-amount';
                        amountSpan.textContent = formatCurrency(bid.amount);

                        const timeSpan = document.createElement('span');
                        timeSpan.className = 'bid-time';
                        timeSpan.textContent = formatRelativeTime(bid.timestamp);

                        rightSide.appendChild(amountSpan);
                        rightSide.appendChild(timeSpan);

                        entry.appendChild(nameSpan);
                        entry.appendChild(rightSide);
                        fragment.appendChild(entry);
                    }

                    els.bidList.innerHTML = '';
                    els.bidList.appendChild(fragment);
                }

                async function pollState() {
                    try {
                        const response = await fetch('/api/state');
                        if (!response.ok) throw new Error('API error');

                        const state = await response.json();
                        renderState(state);
                        lastState = state;
                    } catch (err) {
                        console.error('[Polling] Error:', err);
                    }
                }

                function init() {
                    cacheElements();

                    // Initial poll
                    pollState();

                    // Poll every 1.5 seconds
                    setInterval(pollState, 1500);

                    console.log('[Client] Polling client initialized');
                }

                document.addEventListener('DOMContentLoaded', init);
            })();
        </script>
    </body>
</html>
